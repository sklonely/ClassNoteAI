# 拖放功能問題排查指南

## 問題描述
PDF 文件拖放功能無法正常工作。

## 已實現的修復

### 1. 創建專用拖放組件
- ✅ 創建 `DragDropZone` 組件統一處理拖放邏輯
- ✅ 使用計數器防止子元素觸發錯誤的 dragLeave
- ✅ 支持多種文件獲取方式

### 2. 添加詳細診斷日誌
- ✅ 所有拖放事件都會記錄詳細信息
- ✅ 文件信息、類型、大小等都會記錄
- ✅ 瀏覽器支持檢測

### 3. 改進文件處理邏輯
- ✅ 支持文件路徑和 blob URL
- ✅ 多種文件獲取方式（files, items, webkitGetAsEntry）
- ✅ 改進文件類型驗證

## 排查步驟

### 步驟 1: 檢查控制台日誌

當你拖放文件時，應該在控制台看到以下日誌：

```
[拖放診斷] DragDropZone 組件已掛載
[拖放診斷] 瀏覽器支持拖放: true
[拖放診斷] dragEnter: {...}
[拖放診斷] dragEnter - counter: 1
[拖放診斷] 設置拖放狀態為 true
[拖放診斷] drop: {...}
=== 拖放事件觸發 ===
```

**如果沒有看到這些日誌**：
- 拖放事件可能沒有觸發
- 檢查是否有其他元素覆蓋了拖放區域
- 檢查是否有 CSS 阻止了事件（pointer-events: none）

### 步驟 2: 檢查拖放視覺反饋

當拖放文件到區域時，應該看到：
- 藍色邊框和背景高亮
- "放開以打開 PDF 文件" 提示
- 圖標動畫效果

**如果沒有視覺反饋**：
- `isDragging` 狀態可能沒有正確設置
- 檢查 `dragEnter` 事件是否觸發
- 檢查 CSS 類是否正確應用

### 步驟 3: 檢查文件獲取

在 `drop` 事件中，應該看到：
```
方法1: 從 files 獲取
文件信息: { name: "...", type: "...", size: ... }
```

**如果看到 "無法從拖放事件中獲取文件"**：
- 可能是瀏覽器安全限制
- 可能是 Tauri 環境的特殊處理需求
- 檢查 `dataTransfer.files` 和 `dataTransfer.items` 的內容

### 步驟 4: 檢查 PDF 加載

文件獲取成功後，應該看到：
```
處理文件: ...pdf application/pdf ...
文件驗證通過，開始處理
使用 FileReader 讀取文件
文件讀取成功，創建 blob URL
```

**如果 PDF 加載失敗**：
- 檢查 PDF.js worker 是否正確加載
- 檢查 blob URL 是否正確創建
- 檢查 PDF 文件是否損壞

## 常見問題

### 問題 1: 拖放時沒有視覺反饋
**可能原因**：
- `dragEnter` 事件沒有觸發
- `dataTransfer.types` 不包含 'Files'
- CSS 樣式問題

**解決方案**：
- 檢查控制台是否有 dragEnter 日誌
- 檢查 `dataTransfer.types` 的內容
- 確認拖放區域沒有被其他元素覆蓋

### 問題 2: 拖放後無法獲取文件
**可能原因**：
- `dataTransfer.files` 為空
- `dataTransfer.items` 為空
- 瀏覽器安全限制

**解決方案**：
- 檢查控制台中的 files 和 items 數量
- 嘗試使用不同的文件獲取方法
- 檢查是否有安全策略限制

### 問題 3: PDF 加載失敗
**可能原因**：
- blob URL 創建失敗
- PDF.js worker 加載失敗
- 文件格式問題

**解決方案**：
- 檢查 blob URL 是否正確
- 檢查 PDF.js worker 路徑
- 嘗試用其他 PDF 文件測試

## 測試建議

1. **打開開發者工具**
   - 在 Tauri 應用中，可能需要通過終端查看日誌
   - 或使用瀏覽器開發者工具（如果支持）

2. **測試拖放**
   - 從文件管理器拖放一個 PDF 文件
   - 觀察控制台輸出
   - 檢查視覺反饋

3. **記錄問題**
   - 記錄控制台中的錯誤信息
   - 記錄拖放事件的日誌
   - 記錄文件信息

## 下一步

如果問題仍然存在，請提供：
1. 控制台中的完整日誌輸出
2. 拖放時是否有視覺反饋
3. 是否有錯誤提示
4. 操作系統版本

這樣可以更準確地定位問題。

