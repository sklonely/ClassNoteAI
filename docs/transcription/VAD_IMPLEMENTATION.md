# VAD 切片實施文檔

## ✅ 實施完成：方案 A - VAD + 固定時間上限

### 實施內容

#### 1. **Rust 後端 VAD 模塊** (`src-tauri/src/vad/`)

**功能**：
- ✅ 基於能量的語音活動檢測
- ✅ 語音段落檢測和合併
- ✅ 最大時長強制切片
- ✅ 最小時長過濾

**核心類**：
- `VadDetector`: VAD 檢測器
- `VadConfig`: VAD 配置（能量閾值、時長限制等）
- `SpeechSegment`: 語音段落結構

**Tauri 命令**：
- `detect_speech_segments`: 檢測語音段落

#### 2. **前端 VAD 服務** (`src/services/vadService.ts`)

**功能**：
- ✅ 調用 Rust 後端 VAD API
- ✅ 提取音頻片段
- ✅ 配置 VAD 參數

#### 3. **轉錄服務集成** (`src/services/transcriptionService.ts`)

**改進**：
- ✅ 集成 VAD 進行智能切片
- ✅ 自動回退機制（VAD 失敗時使用直接轉錄）
- ✅ 對每個語音段落分別轉錄

### 工作流程

```
音頻流 → 累積到緩衝區 → VAD 檢測語音段落 → 對每個段落轉錄 → 處理結果
```

1. **音頻累積**：音頻塊累積到緩衝區
2. **觸發條件**：
   - 達到最小時長（2秒）
   - 達到最大時長（10秒）
3. **VAD 檢測**：使用能量檢測識別語音段落
4. **段落處理**：
   - 合併相近的語音段（間隔 < 0.5秒）
   - 過濾太短的片段（< 2秒）
   - 強制切片過長的片段（> 10秒）
5. **轉錄**：對每個語音段落分別轉錄
6. **翻譯**：對轉錄結果進行翻譯

### 配置參數

**默認配置**：
- `energy_threshold`: 0.01 (1% 能量閾值)
- `min_speech_duration_ms`: 2000 (最小 2 秒)
- `max_speech_duration_ms`: 10000 (最大 10 秒)
- `min_silence_duration_ms`: 500 (0.5 秒靜音用於合併)
- `sample_rate`: 16000 Hz
- `window_size_samples`: 1600 (100ms 窗口)

### 優勢

1. **語義完整性**：在語音段落邊界切片，避免在句子中間切斷
2. **實時性好**：基於能量的檢測速度快，適合實時處理
3. **自動優化**：自動合併相近段落，過濾短片段
4. **可靠性**：有回退機制，VAD 失敗時仍可使用

### 測試建議

1. **測試不同音頻質量**：
   - 清晰的語音
   - 有背景噪音的語音
   - 低音量語音

2. **調整參數**：
   - `energy_threshold`: 如果檢測不到語音，降低閾值
   - `min_speech_duration_ms`: 根據實際需求調整
   - `max_speech_duration_ms`: 根據轉錄延遲需求調整

3. **性能監控**：
   - VAD 檢測時間
   - 轉錄延遲
   - 內存使用

### 未來優化方向

1. **升級到 Silero VAD**：
   - 使用 ONNX 模型進行更精確的檢測
   - 更好的噪音處理能力

2. **結合句子邊界檢測**：
   - 轉錄後分析句子邊界
   - 進一步優化切片位置

3. **自適應參數**：
   - 根據音頻質量自動調整閾值
   - 根據語音速度調整窗口大小


