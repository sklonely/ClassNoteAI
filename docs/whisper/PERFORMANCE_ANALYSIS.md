# Whisper è½‰éŒ„æ€§èƒ½åˆ†æ

## ğŸ“Š æ—¥èªŒåˆ†æï¼ˆ744-1044 è¡Œï¼‰

### ğŸ”´ åš´é‡å•é¡Œï¼šæ¯æ¬¡è½‰éŒ„éƒ½é‡æ–°å‰µå»ºç‹€æ…‹

**è§€å¯Ÿåˆ°çš„å•é¡Œ**ï¼š
æ¯æ¬¡è½‰éŒ„éƒ½èª¿ç”¨ `create_state()`ï¼Œå°è‡´é‡æ–°åˆ†é…å¤§é‡å…§å­˜ï¼š

```
whisper_init_state: kv self size  =  220.20 MB
whisper_init_state: kv cross size =  245.76 MB
whisper_init_state: compute buffer (conv)   =   32.42 MB
whisper_init_state: compute buffer (encode) =  212.42 MB
whisper_init_state: compute buffer (cross)  =    9.38 MB
whisper_init_state: compute buffer (decode) =   99.24 MB
```

**ç¸½è¨ˆ**ï¼šæ¯æ¬¡è½‰éŒ„ç´„åˆ†é… **818 MB** å…§å­˜ï¼

### ğŸ“ˆ æ€§èƒ½æ•¸æ“šçµ±è¨ˆ

å¾æ—¥èªŒä¸­æå–çš„æ•¸æ“šï¼š

| æŒ‡æ¨™ | æ•¸å€¼ | èªªæ˜ |
|------|------|------|
| è½‰éŒ„æ¬¡æ•¸ | ~30 æ¬¡ | åœ¨ç´„ 1 åˆ†é˜å…§ |
| å¹³å‡è½‰éŒ„æ™‚é–“ | ~2000ms | å°æ–¼ Large æ¨¡å‹åˆç† |
| éŸ³é »ç‰‡æ®µé•·åº¦ | 1.1-3.0 ç§’ | ç¯„åœï¼š16575-47775 æ¨£æœ¬ |
| æ–‡æœ¬é•·åº¦ | 8-61 å­—ç¬¦ | è¼ƒçŸ­ï¼Œå¯èƒ½ä¸å®Œæ•´ |
| å…§å­˜åˆ†é… | 818 MB/æ¬¡ | æ¯æ¬¡è½‰éŒ„éƒ½é‡æ–°åˆ†é… |

### âš ï¸ ç™¼ç¾çš„å•é¡Œ

#### 1. **å…§å­˜åˆ†é…éåº¦**
- **å•é¡Œ**ï¼šæ¯æ¬¡è½‰éŒ„éƒ½é‡æ–°åˆ†é… 818 MB å…§å­˜
- **å½±éŸ¿**ï¼š
  - åš´é‡çš„å…§å­˜ç¢ç‰‡
  - GC å£“åŠ›å¢åŠ 
  - å¯èƒ½å°è‡´ç³»çµ±å¡é “
- **è§£æ±ºæ–¹æ¡ˆ**ï¼šé‡ç”¨ç‹€æ…‹æˆ–ä½¿ç”¨ç‹€æ…‹æ± 

#### 2. **æ–‡æœ¬é•·åº¦è¼ƒçŸ­**
- **è§€å¯Ÿ**ï¼šæ–‡æœ¬é•·åº¦åªæœ‰ 8-61 å­—ç¬¦
- **å¯èƒ½åŸå› **ï¼š
  - éŸ³é »ç‰‡æ®µå¤ªçŸ­ï¼ˆ1-3 ç§’ï¼‰
  - VAD åˆ‡ç‰‡åˆ‡æ–·äº†å¥å­
  - è½‰éŒ„çµæœä¸å®Œæ•´
- **å»ºè­°**ï¼šå¢åŠ æœ€å°åˆ‡ç‰‡æ™‚é•·æˆ–æ”¹å–„ VAD é‚è¼¯

#### 3. **éŸ³é »éŸ³é‡è®ŠåŒ–å¤§**
- **è§€å¯Ÿ**ï¼šRMS å€¼ç¯„åœ 0.0046-0.0631
- **å•é¡Œ**ï¼šéƒ¨åˆ†éŸ³é »éŸ³é‡éä½ï¼ˆRMS < 0.01ï¼‰
- **å·²è™•ç†**ï¼šè‡ªå‹•å¢ç›Šå·²ç”Ÿæ•ˆï¼ˆ2 æ¬¡æ‡‰ç”¨ 3x å¢ç›Šï¼‰

### ğŸ’¡ å„ªåŒ–å»ºè­°

#### å„ªå…ˆç´š 1ï¼šé‡ç”¨è½‰éŒ„ç‹€æ…‹

**ç•¶å‰å¯¦ç¾**ï¼š
```rust
// æ¯æ¬¡è½‰éŒ„éƒ½å‰µå»ºæ–°ç‹€æ…‹
let mut state = model.get_context().create_state()?;
```

**å„ªåŒ–æ–¹æ¡ˆ**ï¼š
1. **ç‹€æ…‹æ± **ï¼šç¶­è­·ä¸€å€‹ç‹€æ…‹æ± ï¼Œé‡ç”¨ç‹€æ…‹å°è±¡
2. **ç‹€æ…‹é‡ç½®**ï¼šå¦‚æœç‹€æ…‹æ”¯æŒé‡ç½®ï¼Œé‡ç”¨åŒä¸€å€‹ç‹€æ…‹
3. **æ‰¹é‡è™•ç†**ï¼šå°‡å¤šå€‹éŸ³é »ç‰‡æ®µåˆä½µè™•ç†

#### å„ªå…ˆç´š 2ï¼šå„ªåŒ–åˆ‡ç‰‡ç­–ç•¥

**ç•¶å‰å•é¡Œ**ï¼š
- éŸ³é »ç‰‡æ®µå¤ªçŸ­ï¼ˆ1-3 ç§’ï¼‰
- å¯èƒ½åˆ‡æ–·å¥å­

**å»ºè­°**ï¼š
- å¢åŠ æœ€å°åˆ‡ç‰‡æ™‚é•·åˆ° 3-5 ç§’
- æ”¹å–„ VAD é‚è¼¯ï¼Œåœ¨å¥å­é‚Šç•Œè™•åˆ‡ç‰‡
- ä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ‡ç‰‡ç­–ç•¥

#### å„ªå…ˆç´š 3ï¼šéŸ³é »é è™•ç†

**ç•¶å‰å¯¦ç¾**ï¼š
- å·²å¯¦ç¾è‡ªå‹•å¢ç›Šï¼ˆRMS < 0.01 æ™‚ï¼‰
- ä½†é–¾å€¼å¯èƒ½å¤ªä½

**å»ºè­°**ï¼š
- æé«˜å¢ç›Šé–¾å€¼ï¼ˆRMS < 0.02ï¼‰
- æ·»åŠ éŸ³é »é™å™ª
- æ·»åŠ éŸ³é »å¢å¼·

## ğŸ”§ å…·é«”å„ªåŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šç‹€æ…‹é‡ç”¨ï¼ˆæ¨è–¦ï¼‰

```rust
// åœ¨ WhisperService ä¸­ç¶­è­·ç‹€æ…‹
pub struct WhisperService {
    model: Option<WhisperModel>,
    state: Option<WhisperState>, // é‡ç”¨ç‹€æ…‹
}

impl WhisperService {
    pub async fn transcribe(&mut self, ...) -> Result<...> {
        // é‡ç”¨ç‹€æ…‹æˆ–å‰µå»ºæ–°ç‹€æ…‹
        let state = self.state.take()
            .unwrap_or_else(|| model.get_context().create_state()?);
        
        // ... åŸ·è¡Œè½‰éŒ„ ...
        
        // é‡ç½®ç‹€æ…‹ä¾›ä¸‹æ¬¡ä½¿ç”¨
        state.reset()?;
        self.state = Some(state);
    }
}
```

### æ–¹æ¡ˆ Bï¼šæ‰¹é‡è™•ç†

```rust
// å°‡å¤šå€‹çŸ­ç‰‡æ®µåˆä½µè™•ç†
pub async fn transcribe_batch(&self, audio_segments: Vec<&[i16]>) -> Result<Vec<...>> {
    let mut state = model.get_context().create_state()?;
    
    for segment in audio_segments {
        // é‡ç”¨åŒä¸€å€‹ç‹€æ…‹è™•ç†å¤šå€‹ç‰‡æ®µ
        state.full(params, segment)?;
    }
}
```

### æ–¹æ¡ˆ Cï¼šå¢åŠ åˆ‡ç‰‡æ™‚é•·

```typescript
// åœ¨ transcriptionService.ts ä¸­
private minChunkDuration: number = 3000; // å¾ 2000ms å¢åŠ åˆ° 3000ms
private maxChunkDuration: number = 15000; // å¾ 10000ms å¢åŠ åˆ° 15000ms
```

## ğŸ“ ç¸½çµ

**ä¸»è¦å•é¡Œ**ï¼š
1. âœ… æ¯æ¬¡è½‰éŒ„é‡æ–°åˆ†é… 818 MB å…§å­˜ï¼ˆåš´é‡ï¼‰
2. âš ï¸ éŸ³é »ç‰‡æ®µå¤ªçŸ­ï¼Œå¯èƒ½å°è‡´è½‰éŒ„ä¸å®Œæ•´
3. âœ… éŸ³é »éŸ³é‡è‡ªå‹•å¢ç›Šå·²å¯¦ç¾ä¸¦å·¥ä½œæ­£å¸¸

**é æœŸæ”¹é€²**ï¼š
- ç‹€æ…‹é‡ç”¨ï¼šæ¸›å°‘ 90%+ çš„å…§å­˜åˆ†é…
- å¢åŠ åˆ‡ç‰‡æ™‚é•·ï¼šæé«˜è½‰éŒ„å®Œæ•´æ€§
- å„ªåŒ– VADï¼šæ¸›å°‘ä¸å¿…è¦çš„åˆ‡ç‰‡


